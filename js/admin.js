"use strict";
$(function() {

    // Initialize variables
    //var new_applet_xml = "&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;geogebra format=\"5.0\" version=\"5.0.357.0\" id=\"c8a7f44a-9eb8-44d7-8795-b74e70cedb80\"  xsi:noNamespaceSchemaLocation=\"http://www.geogebra.org/ggb.xsd\" xmlns=\"\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" &gt;\n&lt;gui&gt;\n\t&lt;window width=\"800\" height=\"600\" /&gt;\n\t&lt;perspectives&gt;\n&lt;perspective id=\"tmp\"&gt;\n\t&lt;panes&gt;\n\t\t&lt;pane location=\"\" divider=\"0.3325\" orientation=\"1\" /&gt;\n\t&lt;/panes&gt;\n\t&lt;views&gt;\n\t\t&lt;view id=\"1\" visible=\"true\" inframe=\"false\" stylebar=\"false\" location=\"1\" size=\"524\" window=\"100,100,600,400\" /&gt;\n\t\t&lt;view id=\"4\" toolbar=\"0 || 2020 , 2021 , 2022 || 2001 , 2003 , 2002 , 2004 , 2005 || 2040 , 2041 , 2042 , 2044 , 2043\" visible=\"false\" inframe=\"false\" stylebar=\"false\" location=\"1\" size=\"150\" window=\"50,50,500,500\" /&gt;\n\t\t&lt;view id=\"2\" visible=\"true\" inframe=\"false\" stylebar=\"false\" location=\"3\" size=\"266\" window=\"100,100,250,400\" /&gt;\n\t\t&lt;view id=\"8\" toolbar=\"1001 | 1002 | 1003  || 1005 | 1004 || 1006 | 1007 | 1010 || 1008 | 1009 || 6\" visible=\"false\" inframe=\"false\" stylebar=\"false\" location=\"1\" size=\"150\" window=\"50,50,500,500\" /&gt;\n\t\t&lt;view id=\"16\" visible=\"false\" inframe=\"false\" stylebar=\"false\" location=\"1\" size=\"300\" window=\"50,50,500,500\" /&gt;\n\t\t&lt;view id=\"32\" visible=\"false\" inframe=\"false\" stylebar=\"true\" location=\"1\" size=\"300\" window=\"50,50,500,500\" /&gt;\n\t\t&lt;view id=\"64\" toolbar=\"0\" visible=\"false\" inframe=\"false\" stylebar=\"false\" location=\"1\" size=\"480\" window=\"50,50,500,500\" /&gt;\n\t\t&lt;view id=\"128\" visible=\"false\" inframe=\"true\" stylebar=\"false\" location=\"1\" size=\"480\" window=\"50,50,500,500\" /&gt;\n\t\t&lt;view id=\"4097\" visible=\"false\" inframe=\"true\" stylebar=\"true\" location=\"1\" size=\"150\" window=\"50,50,500,500\" /&gt;\n\t\t&lt;view id=\"70\" toolbar=\"0 || 2020 || 2021 || 2022\" visible=\"false\" inframe=\"false\" stylebar=\"true\" location=\"1\" size=\"900\" window=\"50,50,500,500\" /&gt;\n\t\t&lt;view id=\"43\" visible=\"false\" inframe=\"false\" stylebar=\"false\" location=\"1\" size=\"450\" window=\"50,50,500,500\" /&gt;\n\t\t&lt;view id=\"512\" toolbar=\"0 | 1 501 5 19 , 67 | 2 15 45 18 , 7 37 | 514 3 9 , 13 44 , 47 | 16 | 551 550 11 ,  20 22 21 23 , 55 56 57 , 12 | 69 | 510 511 , 512 513 | 533 531 , 534 532 , 522 523 , 537 536 , 535 | 521 520 | 36 , 38 49 560 | 571 30 29 570 31 33 | 17 | 540 40 41 42 , 27 28 35 , 6 , 502\" visible=\"false\" inframe=\"true\" stylebar=\"false\" location=\"1\" size=\"480\" window=\"50,50,500,500\" /&gt;\n\t&lt;/views&gt;\n\t&lt;toolbar show=\"true\" items=\"0 | 1 501 67 , 5 19 , 72 75 76 | 2 15 45 , 18 65 , 7 37 | 4 3 8 9 , 13 44 , 58 , 47 | 16 51 64 , 70 | 10 34 53 11 , 24  20 22 , 21 23 | 55 56 57 , 12 | 36 46 , 38 49  50 , 71 | 30 29 54 32 31 33 | 17 26 62 73 , 14 68 | 25 52 60 61 | 40 41 42 , 27 28 35 , 6\" position=\"1\" help=\"false\" /&gt;\n\t&lt;input show=\"true\" cmd=\"true\" top=\"algebra\" /&gt;\n\t&lt;dockBar show=\"false\" east=\"false\" /&gt;\n&lt;/perspective&gt;\n\t&lt;/perspectives&gt;\n\t&lt;labelingStyle  val=\"0\"/&gt;\n\t&lt;font  size=\"12\"/&gt;\n&lt;/gui&gt;\n&lt;euclidianView&gt;\n\t&lt;viewNumber viewNo=\"1\"/&gt;\n\t&lt;size  width=\"524\" height=\"545\"/&gt;\n\t&lt;coordSystem xZero=\"262\" yZero=\"272.5\" scale=\"11.674199380165296\" yscale=\"11.674199380165286\"/&gt;\n\t&lt;evSettings axes=\"true\" grid=\"false\" gridIsBold=\"false\" pointCapturing=\"3\" rightAngleStyle=\"1\" checkboxSize=\"26\" gridType=\"0\"/&gt;\n\t&lt;bgColor r=\"255\" g=\"255\" b=\"255\"/&gt;\n\t&lt;axesColor r=\"0\" g=\"0\" b=\"0\"/&gt;\n\t&lt;gridColor r=\"192\" g=\"192\" b=\"192\"/&gt;\n\t&lt;lineStyle axes=\"1\" grid=\"0\"/&gt;\n\t&lt;axis id=\"0\" show=\"true\" label=\"\" unitLabel=\"\" tickStyle=\"1\" showNumbers=\"true\"/&gt;\n\t&lt;axis id=\"1\" show=\"true\" label=\"\" unitLabel=\"\" tickStyle=\"1\" showNumbers=\"true\"/&gt;\n&lt;/euclidianView&gt;\n&lt;algebraView&gt;\n\t&lt;collapsed val=\"0\"/&gt;\n&lt;/algebraView&gt;\n&lt;kernel&gt;\n\t&lt;continuous val=\"false\"/&gt;\n\t&lt;usePathAndRegionParameters val=\"true\"/&gt;\n\t&lt;decimals val=\"2\"/&gt;\n\t&lt;angleUnit val=\"degree\"/&gt;\n\t&lt;algebraStyle val=\"0\" spreadsheet=\"0\"/&gt;\n\t&lt;coordStyle val=\"0\"/&gt;\n\t&lt;angleFromInvTrig val=\"false\"/&gt;\n&lt;/kernel&gt;\n&lt;scripting blocked=\"false\" disabled=\"false\"/&gt;\n&lt;construction title=\"\" author=\"\" date=\"\"&gt;\n&lt;/construction&gt;\n&lt;/geogebra&gt;";
    
    var toolbar_locs = []; // The array that stores all the toolbars
        while(toolbar_locs.push([]) < 12);

     $('[data-toggle="tooltip"]').tooltip(); //enable tooltips
    
    // Connect to the server using the Admin.Socket object constructor
    
    var class_id; // Declaring class id globally in this file


    var $secret = "ucd_247"; // Setting the secret up for further destruction

    // Start with secret view visible and create/manage/settings view hidden
    $create_view.hide();
    $class_view.hide();
    $create_user_view.hide();

    //
    // Called to check if user is logged in
    //
    if(localStorage.getItem('admin_id')){
        if(localStorage.getItem('check')){
            socket.check_session(localStorage.getItem('admin_id'), localStorage.getItem('check'));
        }
    }
    
    $username_password_view.show();
    $container.show();

    //
    // CHECKING THE USERNAME AND PASSWORD COMBINATION
    //
    $login_button.bind('click', function() {
        socket.check_username($username.val(), $password.val(), $secret);
    });


    //
    //  Pinging
    //
    window.setInterval(function(){
        var d = new Date();
        socket.ping(d.getTime());
    }, 500);

    
    //
    // SUBMIT PASSWORD HITTING ENTER KEY
    //
    $password.keypress(function(e) {
        if (e.which == 13) {
            socket.check_username($username.val(), $password.val(), $secret);
        }
    });

    //
    // SUBMIT USERNAME HITTING ENTER KEY
    //
    $username.keypress(function(e) {
        if (e.which == 13) {
            socket.check_username($username.val(), $password.val(), $secret);
        }
    });
    

    //
    // TO CREATE NEW USER
    //
    $new_user.bind('click', function() {
        $username_password_view.hide();
        $create_user_view.show();
    });

    //
    // CREATE CLASS
    //
    $create_button.bind('click', function() {
        // Tell the server to create a class in the database
        if ($class_input.val().trim() == "") {
            $class_input.css("border-color", "red");
            $empty_class_input.show();
        }
        else{
            var group_colors = [];

            for(var i = 0; i < parseInt($group_input.val().trim()); i++) {
                var colors = [], minimum = 0, maximum = 255;
                colors.push(Math.floor(Math.random() * (maximum - minimum + 1)) + minimum);
                colors.push(Math.floor(Math.random() * (maximum - minimum + 1)) + minimum);
                colors.push(Math.floor(Math.random() * (maximum - minimum + 1)) + minimum);
                var color = colors.join('-');
                group_colors[i] = color;

            }
            socket.add_class($class_input.val().trim(), parseInt($group_input.val().trim()), $secret, localStorage.getItem('admin_id'), group_colors);
        }
    });

    //
    // GETTING BACK TO LOGIN SCREEN
    //
    $create_admin_back.bind('click', function() {
        $create_user_view.hide();
        $username_password_view.show();
        $new_username.val("");
        $new_password.val("");
        $re_new_password.val("");
        $Secret.val("");

        $error_new_username.hide();
        $new_username.css("border-color", null);
        $error_re_new_password.hide();
        $re_new_password.css("border-color", null);

    });

    //
    // JOIN CLASS
    //
    $join_button.bind('click', function() {
        socket.join_class($class_id.val().trim(), $secret);
    });

    //
    // ADD GROUP
    //
    $add_button.bind('click', function() {
        // Tell the server to create a new group for the class in the database
        var colors = [], minimum = 0, maximum = 255;
        gen_new_colors = true;
        filtered_merged_view_obj_colors = [];
        colors.push(Math.floor(Math.random() * (maximum - minimum + 1)) + minimum);
        colors.push(Math.floor(Math.random() * (maximum - minimum + 1)) + minimum);
        colors.push(Math.floor(Math.random() * (maximum - minimum + 1)) + minimum);
        socket.add_group(sessionStorage.getItem('admin_class_id'), $secret, colors);
    });

    //
    // CREATING A NEW ADMIN
    //
    $create_admin_button.bind('click', function() {

        if($new_password.val() == $re_new_password.val())
            socket.create_admin($new_username.val(), $new_password.val(),  $Secret.val());
        else{
            $re_new_password.css("border-color", "red");
            $error_re_new_password.show();
        }
            
    });

    //
    // DELETE GROUP
    //
    $delete_button.bind('click', function() {
        // Only remove if there are groups
        if ($('.groups > li').length > 0) {
            gen_new_colors = true;
            filtered_merged_view_obj_colors = [];
            socket.delete_group(sessionStorage.getItem('admin_class_id'), $('.groups > li:last').index() + 1, $secret);
        }
    });

    //
    // LEAVE CLASS
    //
    $leave_button.bind('click', function() {
        var numgroups = ($('ul.groups div').length)+1;
        var xml = new_applet_xml;
        for(var i = 1; i < numgroups; i++){
            var data = {
                username: 'admin',
                class_id: sessionStorage.getItem('admin_class_id'),
                group_id: i,
                xml: xml,
                toolbar: '',
                toolbar_user: ''
            };
            socket.xml_change(data);
        }
        socket.leave_class(sessionStorage.getItem('admin_class_id'), $secret, false);

    });

    //
    // SAVE SETTTINGS
    //
    $save_button.bind('click', function() {
        var data = {};
        for(var i=0; i<$settings.length; i++) {
            data[$settings[i].name] = $settings[i].checked;
        }
        socket.save_settings(sessionStorage.getItem('admin_class_id'), data, $secret);
    });

    //
    // SEND TOOLBAR
    //
    $sendtoolbar_button.bind('click', function(){
        var numgroups = ($('ul.groups div').length)+1;
        var toolbar_str = toolbar_locs.join('|');
        var toolbar_users = $('.toolbar_users').val();
        if(!toolbar_users){
            $('.toolbar_users option').prop('selected', true);
            toolbar_users = $('.toolbar_users').val();
        }
        var index = $perspectiveSelect[0].selectedIndex;
        var class_id = sessionStorage.getItem('admin_class_id');
        var perspective = ($perspective.val() != '' && $perspective.is(':visible')) 
            ? $perspective.val() : $perspectiveSelect[0].options[index].value;
        var coord_system, axis_steps;
        
        if ($axis_step_x.val() != "" | $axis_step_y.val() != "" | $axis_step_z.val() != ""){
            axis_steps = {
                'x' : (($.isNumeric($axis_step_x.val())) ? $axis_step_x.val() : 0),
                'y' : (($.isNumeric($axis_step_y.val())) ? $axis_step_y.val() : 0),
                'z' : (($.isNumeric($axis_step_z.val())) ? $axis_step_z.val() : 0)
            };
        }

        if ($coord_x_min.val() != "" | $coord_x_max.val() != ""  | $coord_y_min.val() != "" | $coord_y_max.val() != ""){
            coord_system = {
                'x_min' : (($.isNumeric($coord_x_min.val())) ? $coord_x_min.val() : 0),
                'x_max' : (($.isNumeric($coord_x_max.val())) ? $coord_x_max.val() : 0),
                'y_min' : (($.isNumeric($coord_y_min.val())) ? $coord_y_min.val() : 0),
                'y_max' : (($.isNumeric($coord_y_max.val())) ? $coord_y_max.val() : 0)
            };
        }
        
        /* Setting Property Values for Graphics Window 2 */
        var g2coord_system, g2axis_steps, g2axis_display, g2grid_display, g2axis_steps, g2coord_system;
        
        if ($g2axis_step_x.val() != "" | $g2axis_step_y.val() != "" | $g2axis_step_z.val() != ""){
            g2axis_steps = {
                'x' : (($.isNumeric($g2axis_step_x.val())) ? $g2axis_step_x.val() : 0),
                'y' : (($.isNumeric($g2axis_step_y.val())) ? $g2axis_step_y.val() : 0),
                'z' : (($.isNumeric($g2axis_step_z.val())) ? $g2axis_step_z.val() : 0)
            };
        }

        if ($g2coord_x_min.val() != "" | $g2coord_x_max.val() != ""  | $g2coord_y_min.val() != "" | $g2coord_y_max.val() != ""){
            g2coord_system = {
                'x_min' : (($.isNumeric($g2coord_x_min.val())) ? $g2coord_x_min.val() : 0),
                'x_max' : (($.isNumeric($g2coord_x_max.val())) ? $g2coord_x_max.val() : 0),
                'y_min' : (($.isNumeric($g2coord_y_min.val())) ? $g2coord_y_min.val() : 0),
                'y_max' : (($.isNumeric($g2coord_y_max.val())) ? $g2coord_y_max.val() : 0)
            };
        }
        
        if ($g2Toggle.is(':checked'))
        {
            g2axis_display = $axisToggle.prop('checked'),
            g2grid_display = $gridToggle.prop('checked'),
            g2axis_steps = axis_steps,
            g2coord_system = coord_system
        }
        else
        {
            g2axis_display = $g2axisToggle.prop('checked'),
            g2grid_display = $g2gridToggle.prop('checked'),
            g2axis_steps = g2axis_steps,
            g2coord_system = g2coord_system
        }

        /* End of Setting Property Values for Graphics Window 2 */

        var properties = {
            axis_display: $axisToggle.prop('checked'),
            grid_display: $gridToggle.prop('checked'),
            perspective: perspective,
            axis_steps: axis_steps,
            coord_system: coord_system,
            g2axis_display : g2axis_display,
            g2grid_display : g2grid_display,
            g2axis_steps : g2axis_steps,
            g2coord_system : g2coord_system
        };

        for(var i = 0; i < toolbar_users.length; i++){
            var user_data = toolbar_users[i].split('|');
            if (user_data.length < 2){
                continue;
            }
            var group_id = user_data[0];
            var toolbar_user  = user_data[1];
            var data = {
                username: 'admin',
                class_id: class_id,
                group_id: group_id,
                xml: '',
                toolbar: toolbar_str,
                toolbar_user: toolbar_user,
                properties: properties
            };
            socket.xml_change(data);
        }
        //$("option:selected").prop("selected", false);
    });

    $perspectiveBox.toggle();
    $boxToggle.bind('click', function(){
        $perspectiveBox.toggle();
    });
    
    /* Use Graphics 1 Config or Different Config for Graphics 2 Window */
    $g2Toggle.prop('checked', true);
    $g2Box.toggle();
    $g2Toggle.bind('click', function(){
        $g2Box.toggle();
    });
    /* End of Graphics 2 Window Config Toggle */


    $sendconstruction_button.bind('click', function(){
        var xml = $.parseXML(document.applet.getXML());
        // console.log(document.applet.getXML());
        var toolbar = $(xml).find('toolbar').attr('items').replace(/  /g, " ").replace(/ \| /g, "|").replace(/ /g, ",");
        console.log(toolbar);
        var construction_groups = $('.construction_groups').val();
        if(!construction_groups){
            $('.construction_groups option').prop('selected', true);
            construction_groups = $('.construction_groups').val();
        }
        console.log(construction_groups);
        for(var i = 0; i < construction_groups.length; i++){
            var data = {
                username: 'admin',
                class_id: sessionStorage.getItem('admin_class_id'),
                group_id: construction_groups[i],
                xml: document.applet.getXML(),
                toolbar: toolbar,
                toolbar_user: 'admin',
                properties: {'perspective': 'AG',
                            'xZero': $(xml).find('coordSystem').attr('xZero'),
                            'yZero': $(xml).find('coordSystem').attr('yZero'),
                            'scale': $(xml).find('coordSystem').attr('scale'),
                            'yscale': $(xml).find('coordSystem').attr('yscale')
                        }
            };
            socket.xml_change(data);
        }
    });

    $sendconstruction_all_button.bind('click', function(){
        var construction_groups_opt = $('.construction_groups option');
        construction_groups_opt.prop('selected', true);
        $sendconstruction_button.click();
        construction_groups_opt.prop('selected', false);
    });

    //
    // Clearing the Class
    //
    $clear_class_button.bind('click', function(){
        var numgroups = ($('ul.groups div').length)+1;
        var xml = new_applet_xml;
        for(var i = 1; i < numgroups; i++){
            var data = {
                username: 'admin',
                class_id: sessionStorage.getItem('admin_class_id'),
                group_id: i,
                xml: xml,
                toolbar: '',
                toolbar_user: ''
            };
            socket.xml_change(data);
        }
    });


    //
    // Clearing the group
    //
    $clear_group_button.bind('click', function(){
        if($choices.is(":visible")){
            $choices.hide();
        } else {
            $choices.show();
            var numgroups = ($('ul.groups div').length)+1;
            var list = "<div class='panel panel-default'><div class='panel-body'>";
            for(var i = 1; i < numgroups; i++){
               list += '<input type="checkbox" value = "' + i + '"> Group ' + i +' <br>';
            }
            list += '<br/><input type="submit" value = "Clear Selected Groups"></div></div>'
             $choices.html(list);
        }
    });


    $choices.submit(function(e){

        // array that will store all the values for checked ones
        var allVals = [];

        $('.choices input[type="checkbox"]:checked').each(function() {

            // looping through each checkbox and storing values in array for checked ones.
            allVals.push($(this).val());

        });
        
        var xml = new_applet_xml;        
        for(var i = 0; i<allVals.length; i++)
        {
            var data = {
                username: 'admin',
                class_id: sessionStorage.getItem('admin_class_id'),
                group_id: allVals[i],
                xml: xml,
                toolbar: '',
                toolbar_user: ''
            };
            socket.xml_change(data);
        }
        $choices.hide();
        e.preventDefault();
    });

    //
    // SAVING A TOOLBAR
    //
    $savetoolbar_button.bind('click', function(){
        var $toolbar_select_opt = $('#toolbar_select option');
        var index = $toolbar_select[0].selectedIndex;
        var tools = toolbar_locs.join('|');
        var toolbar_name = index > -1 ? (confirm("This will save over the old toolbar."), $toolbar_select[0][index].text) : prompt("Enter toolbar name");
        var len = $toolbar_select_opt.length;
        
        for(var i = 0; i < len; i++)
        {
            if($toolbar_select_opt[i].text == toolbar_name)
                break;
        }

        if (i == len && index == -1)
            socket.save_toolbar(localStorage.getItem('admin_id'), toolbar_name, tools, "insert");
        else if (i != len && index != -1){
            socket.save_toolbar(localStorage.getItem('admin_id'), toolbar_name, tools, "update");
        }
        else if (i != len && index == -1)
            alert("You already have a toolbox with that name");

    });

    //
    // USING A TOOLBAR
    //
    $usetoolbar_button.bind('click', function(){
        var select = $toolbar_select[0];
        var id = select.selectedIndex;
        var array = select[id].tool.split('|');
        var i,j;

        for(i = 0; i < 12; i++ ){
            $('#toolbar-target-' + i).empty();
            toolbar_locs[i] = [];
        }
        
        for( i = 0; i < array.length; i++){
            var temp = array[i].split(',');
            for ( j = 0; j < temp.length; j++ ){
                if(temp[j] != ""){
                    var this_tool = $(".toolbox div[data-mode='" + temp[j] + "']");
                    var target = $('#toolbar-target-'+i);
                    var location = $design_icons.index(target);
                    var mode = this_tool.attr("data-mode");
                    var button = $('<button>');
                    var tb_index = toolbar_locs[location].push(mode) - 1;
                    var toolbar_tool = this_tool.clone();
                    button.html('-');
                    button.bind('click', function(){
                        var tool = $(this).parent();
                        toolbar_locs[tool.parent().index(0)].splice(tool.index(0),1);
                        $design_toolbox.append(tool);
                        tool.remove();
                    });
                    toolbar_tool.append(button);
                    target.append(toolbar_tool);

                }
            }
        }
        $(select[id]).prop("selected", false);
    });

    //
    // DELETING A TOOLBAR
    //
    $deletetoolbar_button.bind('click', function(){
        var result = confirm("Are you sure you want to delete this toolbar?");
        if (result) {
            var select = $toolbar_select[0];
            var id = select.selectedIndex;

            socket.delete_toolbar(localStorage.getItem('admin_id'), select[id].text);
        }
    });

    //
    // SAVING A CONSTRUCTION
    //
    $saveconstruction_button.bind('click', function(){
        var $construction_select_opt = $('#construction_select option');
        var index = $construction_select[0].selectedIndex;
        var construction_name = index > -1 ? (confirm("This will save over the old construction."), $construction_select[0][index].text) : prompt("Enter construction name");
        var len = $construction_select_opt.length;
        var xml = document.applet.getXML();
        var parsedXML = $.parseXML(xml);
        var toolbar = $(parsedXML).find('toolbar').attr('items').replace(/,/g, "").replace(/  /g, " ").replace(/ \| /g, "|").replace(/ /g, ",");
        for(var i = 0; i < len; i++)
        {
            if($construction_select_opt[i].text == construction_name)
                break;
        }


        if (i == len && index == -1)
            socket.save_xml(localStorage.getItem('admin_id'), construction_name, xml, toolbar, "insert");
        else if (i != len && index != -1)
            socket.save_xml(localStorage.getItem('admin_id'), construction_name, xml, toolbar, "update");
        else if (i != len && index == -1) 
            alert("You already have a construction with that name");

    });

    //
    // USING A CONSTRUCTION
    //
    $useconstruction_button.bind('click', function(){
        var select = $construction_select[0];
        var id = select.selectedIndex;
        var xml = $construction_select[0][id].xml;
        var toolbar = $construction_select[0][id].toolbar;
        var properties = {perspective: "AG"}
        appletSetExtXML(xml, toolbar, properties); 
        
        $(select[id]).prop("selected", false);
    });

    //
    // DELETING A CONSTRUCTION
    //
    $deleteconstruction_button.bind('click', function(){
        var result = confirm("Are you sure you want to delete this toolbar?");
        if (result) {
            var select = $construction_select[0];
            var id = select.selectedIndex;

            socket.delete_xml(localStorage.getItem('admin_id'), select[id].text);
        }
    });

    //
    // LOGGING OUT
    //
    $logout_class_button.bind('click', function(){
        
        $create_view.hide();
        $settings_tab.hide();
        $username_password_view.show();
        
        socket.delete_session(localStorage.getItem('admin_id'));

        localStorage.setItem('admin_id', '');
        localStorage.setItem('check', '');
        sessionStorage.setItem('admin_secret', '');
        $('.error_password').hide();
        $('.error_username').hide();
        $('.error_class_input').hide();
        $password.css("border-color", null);
        $username.css("border-color", null);
        $class_input.css("border-color", null);
        $class_input.val("");
        $group_input.val("");



    });

    // 
    // CLEARING THE TOOLBAR
    //
    $trash_button.bind('click', function(){

        for(var i = 0; i < 12; i++ )
        {
            $('#toolbar-target-' + i).empty();
            toolbar_locs[i] = [];
        }
    });

    //
    // DELETING CLASS
    //
    $delete_class_button.bind('click', function(e)
    {
        var password = prompt('If you really want to delete class, then enter secret password')    

        if (password == $secret)
        {
           alert('Correct! The class has been deleted. Press OK to continue.');
           socket.delete_class(sessionStorage.getItem('admin_class_id'), $secret, true);
        }
    });

    //
    // SETTINGS CHANGE PASSWORD BUTTON 
    //
    $change_password_button.bind('click', function() {
        if ($changed_password.val() !== $retyped_changed_password.val()) {
            $('.error_password_incorrect').hide();
            $current_password.css('border-color',  '#CCCCCC'); 
            $('.error_password_mismatch').show();
            $changed_password.css('border-color', 'red'); 
            $retyped_changed_password.css('border-color', 'red');
        }
        else {
            $('.error_password_mismatch').hide();
            $changed_password.css('border-color',  '#CCCCCC'); 
            $retyped_changed_password.css('border-color', '#CCCCCC');
            socket.change_password(localStorage.getItem('admin_id'), $current_password.val(), $changed_password.val(), $secret);
        }
    });

    // 
    // MODAL LOGIN BUTTON
    //
    $redirect_login_button.bind('click', function() {
        redirect_modal_submit($redirect_modal.attr("group_id"), $redirect_username.val());
    });

    //
    // SUBMIT USERNAME HITTING ENTER KEY FOR MODAL
    //
    $redirect_username.keypress(function(e) {
        if (e.which == 13) {
            redirect_modal_submit($redirect_modal.attr("group_id"), $redirect_username.val());
        }
    });

    //
    // TAB CHANGES
    // 
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        //e.target  newly activated tab
        //e.relatedTarget  previous active tab
        var tab = String(e.target).split('#')[1];
        //alert(tab);
        if(tab == 'design'){
            if(!document.applet){
                var params = {
                    "container":"appletContainer",
                    "id":"applet",
                    "width":$applet_activity_designer.innerWidth(),
                    "height":600,
                    "perspective":"AG",
                    "showAlgebraInput":true,
                    "showToolBarHelp":false,
                    "showMenubar":true,
                    "enableLabelDrags":false,
                    "showResetIcon":true,
                    "showToolbar":true,
                    "allowStyleBar":false,
                    "useBrowserForJS":true,
                    "enableShiftDragZoom":true,
                    "errorDialogsActive":true,
                    "enableRightClick":false,
                    "enableCAS":false,
                    "enable3d":false,
                    "isPreloader":false,
                    "screenshotGenerator":false,
                    "preventFocus":false,
                    "scaleContainerClass": "appletContainer"
                };
                appletInit(params);
            }   
            getToolbarIcons();
            

            $design_icons.droppable({
                drop: function( event, ui ) {
                    var target = $(this);
                    var location = $design_icons.index(target);
                    var mode = ui.draggable.attr("data-mode");
                    var button = $('<button>');
                    var tb_index = toolbar_locs[location].push(mode) - 1;
                    var toolbar_tool = ui.draggable.clone();
                    button.html('-');
                    button.bind('click', function(){
                        var tool = $(this).parent();
                        toolbar_locs[tool.parent().index(0)].splice(tool.index(0),1);
                        $('.toolbox').append(tool);
                        tool.remove();
                    });
                    toolbar_tool.append(button);
                    
                    target.append(toolbar_tool);
                }
            });

            // // listen for menu bar checkbox toggle and re-inject applet
            // $('#toggle-menu-bar').bind('change',function(){
            //     if($(this).is(':checked')){
            //         params.showMenubar = true;
            //         params.allowStyleBar = false;
            //     }else{
            //         params.showMenubar = false;
            //     };
            //     appletInit(params);
            // });
            socket.get_toolbars(localStorage.getItem('admin_id'));
            socket.get_xmls(localStorage.getItem('admin_id'));

        }else if (tab == 'view'){
            $design_toolbox.empty();
            $views_jsapp.empty();
            $('#views_checkboxes').html('<div class="panel-heading"><h3 class="panel-title">Show Groups</h3></div><div class="panel-body"></div>');
            var numgroups = ($('ul.groups div').length)+1;
            for(var i = 1; i < numgroups; i++){
                var params = {
                    "container":"appletContainer"+i,
                    "id":"applet"+i,
                    "width":300,
                    "height":300,
                    "perspective":"G",
                    "showAlgebraInput":false,
                    "showToolBarHelp":false,
                    "showMenubar":false,
                    "enableLabelDrags":false,
                    "showResetIcon":false,
                    "showToolbar":false,
                    "data-param-id": "loadXML" + i,
                    "allowStyleBar":false,
                    "useBrowserForJS":true,
                    "enableShiftDragZoom":true,
                    "errorDialogsActive":true,
                    "enableRightClick":false,
                    "enableCAS":false,
                    "enable3d":false,
                    "isPreloader":false,
                    "screenshotGenerator":false,
                    "preventFocus":true
                };
                var newgroup = '<div class="views_group_'+i+' col-md-4 col-sm-5 col-lg-4" ><h4><a href="javascript:redirect('+i+')"> Group ' + i + 
                    '</h4><div class="geogebrawebapplet" id="appletContainer'+ i + 
                    '"style="width:100%;height:650px;display:block;"></div></div>';

                var checkbox = '<label><input checked type="checkbox" onchange="views_change(this)" value="applet'+i+'" name="views_group_'+ i
                + '">Group '+ i + '</label>';

                $views_jsapp.append(newgroup);
                $('#views_checkboxes .panel-body').append(checkbox);
                appletInit(params);                
            }
            var params = {
                    "container":"appletContainer"+numgroups,
                    "id":"applet"+numgroups,
                    "width":800,
                    "height":800,
                    "perspective":"G",
                    "showAlgebraInput":false,
                    "showToolBarHelp":false,
                    "showMenubar":true,
                    "enableLabelDrags":false,
                    "showResetIcon":false,
                    "showToolbar":false,
                    "data-param-id": "loadXML" + numgroups,
                    "allowStyleBar":false,
                    "useBrowserForJS":true,
                    "enableShiftDragZoom":true,
                    "errorDialogsActive":true,
                    "enableRightClick":false,
                    "enableCAS":false,
                    "enable3d":false,
                    "isPreloader":false,
                    "screenshotGenerator":false,
                    "preventFocus":true
                };
            var mergegroup = '<div class="merge_group" style="visibility:hidden"><h4> Merge Group</h4><div class="geogebrawebapplet"' +
                'id="appletContainer' + numgroups + '"style="width:100%;height:650px;display:block;"></div></div><br/>';

            var mergebutton = '&emsp;&emsp;<input class="btn btn-default mergeview_button" onclick="view_merge(this)"'+
                ' type="button" value="Merge Checked Views"><input class="btn btn-default unmergeview_button" onclick="unmerge_views(this)"'+
                ' type="button" value="Unmerge Views" style="display:none;">';
            $('#views_checkboxes .panel-body').append(mergebutton);
            $views_jsapp.append(mergegroup);
            appletInit(params);
        }
        /* Filtered Merged View Tab */ 
        else if (tab == 'filtered_merged_view'){
            $design_toolbox.empty();
            $individual_groups_view_jsapps.empty();

            var merge_view_update_toggle = '<div class="onoffswitch" style="display:none;"> <input type="checkbox" name="onoffswitch" '
            +'class="onoffswitch-checkbox" id="myonoffswitch" onchange="liveUpdatesCheckboxChange(this);" checked> </input> <label class="onoffswitch-label" for="myonoffswitch">' 
            +'<span class="onoffswitch-inner"></span> <span class="onoffswitch-switch"></span> </label></div>';
            $individual_groups_view_jsapps.append(merge_view_update_toggle);

            $('#group_select_checkboxes').html('<div class="panel-heading"><h3 class="panel-title">Show Groups</h3></div><div class="panel-body"></div>');
            $('#filter_merge_items').html('<div class="panel-heading"><h3 class="panel-title">Select Object Types to Be Merged</h3></div><div class="panel-body"></div>');
            var numgroups = ($('ul.groups div').length)+1;
            for(var i = 1; i < numgroups; i++){
                var params = {
                    "container":"merged_view_appletContainer"+i,
                    "id":"merged_view_applet"+i,
                    "width":300,
                    "height":300,
                    "perspective":"G",
                    "showAlgebraInput":false,
                    "showToolBarHelp":false,
                    "showMenubar":false,
                    "enableLabelDrags":false,
                    "showResetIcon":false,
                    "showToolbar":false,
                    "data-param-id": "loadXML" + i,
                    "allowStyleBar":false,
                    "useBrowserForJS":true,
                    "enableShiftDragZoom":true,
                    "errorDialogsActive":true,
                    "enableRightClick":false,
                    "enableCAS":false,
                    "enable3d":false,
                    "isPreloader":false,
                    "screenshotGenerator":false,
                    "preventFocus":true
                };
                var newgroup = '<div class="views_group_'+i+' col-md-4 col-sm-5 col-lg-4" ><h4><a href="javascript:redirect('+i+')"> Group ' + i + 
                    '</h4><div class="geogebrawebapplet" id="merged_view_appletContainer'+ i + 
                    '"style="width:100%;height:650px;display:block;visibility:hidden;"></div></div>';

                var checkbox = '<label><input checked type="checkbox" onchange="views_change(this)" value="merged_view_applet'+i+'" name="views_group_'+ i
                + '">Group '+ i + '</label>';

                $individual_groups_view_jsapps.append(newgroup);
                $('#group_select_checkboxes .panel-body').append(checkbox);
                appletInit(params);
            }
            
            //Wait for Applets to be Loaded and Then Randomize Colors
            var applets_loaded = 0;
            var interval_id = setInterval(function() {
               //Once all Applets are Loaded Stop Trying
                if(applets_loaded == 1)
                {
                    for(var i = 1; i < numgroups; i++)
                    {
                        if(gen_new_colors == true)
                        {
                            filtered_merged_view_obj_colors.push(randomizeColors(gen_new_colors,[],document['merged_view_applet'+i]));
                        }
                        else
                        {
                            randomizeColors(gen_new_colors,filtered_merged_view_obj_colors[i-1],document['merged_view_applet'+i]);
                        }
                        document.getElementById('merged_view_appletContainer'+i).style.visibility = "visible";
                    }
                    gen_new_colors = false;
                    clearInterval(interval_id);
                }
                if(document['merged_view_applet1'] !== undefined || numgroups === 0 )
                {
                    applets_loaded = 1;
                }
            }, 1000);
            
            var params = {
                    "container":"merged_view_appletContainer"+numgroups,
                    "id":"merged_view_applet"+numgroups,
                    "width":800,
                    "height":800,
                    "perspective":"G",
                    "showAlgebraInput":false,
                    "showToolBarHelp":false,
                    "showMenubar":true,
                    "enableLabelDrags":false,
                    "showResetIcon":false,
                    "showToolbar":false,
                    "data-param-id": "loadXML" + numgroups,
                    "allowStyleBar":false,
                    "useBrowserForJS":true,
                    "enableShiftDragZoom":true,
                    "errorDialogsActive":true,
                    "enableRightClick":false,
                    "enableCAS":false,
                    "enable3d":false,
                    "isPreloader":false,
                    "screenshotGenerator":false,
                    "preventFocus":true
                };
            var mergegroup = '<div class="filtered_merge_group" style="visibility:hidden"><h4> Merge Group</h4><div class="geogebrawebapplet"' +
                'id="merged_view_appletContainer' + numgroups + '"style="width:100%;height:650px;display:block;"></div></div><br/>';

            var mergebutton = '&emsp;&emsp;<input class="btn btn-default filtered_mergeview_button" onclick="filtered_view_merge(this)"'+
                ' type="button" value="Merge Checked Views"><input class="btn btn-default filtered_unmergeview_button" onclick="filtered_unmerge_views(this)"'+
                ' type="button" value="Unmerge Views" style="display:none;">';

            var obj_merge_selection = '&emsp;&emsp;<input type="checkbox" name="merge_objs" style="display:inline;" value="point"> Points'+
            '&emsp;<input type="checkbox" name="merge_objs" style="display:inline;" value="line"> Lines'+
            '&emsp;<input type="checkbox" name="merge_objs" style="display:inline;" value="conic"> Conics';

            $('#group_select_checkboxes .panel-body').append(mergebutton);
            $('#filter_merge_items .panel-body').append(obj_merge_selection);
            $individual_groups_view_jsapps.append(mergegroup);
            appletInit(params);

        } 
        /* Overlayed Image View Tab */ 
        else if (tab == 'overlayed_image_view'){
            $design_toolbox.empty();
            $overlayed_image_views_jsapps.empty();
            $('#overlayed_image_views_checkboxes').html('<div class="panel-heading"><h3 class="panel-title">Show Groups</h3></div><div class="panel-body"></div>');
            $('#overlayed_image_div').html('<div class="panel-heading"><h3 class="panel-title">Overlayed Image</h3></div><div class="panel-body" style="width:60%;height:350px;display:block;"></div>');
            var numgroups = ($('ul.groups div').length)+1;
            for(var i = 1; i < numgroups; i++){
                var params = {
                    "container":"overlayed_image_view_appletContainer"+i,
                    "id":"overlayed_image_view_applet"+i,
                    "width":300,
                    "height":300,
                    "perspective":"G",
                    "showAlgebraInput":false,
                    "showToolBarHelp":false,
                    "showMenubar":false,
                    "enableLabelDrags":false,
                    "showResetIcon":false,
                    "showToolbar":false,
                    "data-param-id": "loadXML" + i,
                    "allowStyleBar":false,
                    "useBrowserForJS":true,
                    "enableShiftDragZoom":false,
                    "errorDialogsActive":true,
                    "enableRightClick":false,
                    "enableCAS":false,
                    "enable3d":false,
                    "isPreloader":false,
                    "screenshotGenerator":false,
                    "preventFocus":true
                };
                var newgroup = '<div class="views_group_'+i+' col-md-4 col-sm-5 col-lg-4" ><h4><a href="javascript:redirect('+i+')"> Group ' + i + 
                    '</h4><div class="geogebrawebapplet" id="overlayed_image_view_appletContainer'+ i + 
                    '"style="width:100%;height:650px;display:block;"></div></div>';

                var checkbox = '<label><input checked type="checkbox" onchange="views_change(this)" value="overlayed_image_view_applet'+i+'" name="views_group_'+ i
                + '">Group '+ i + '</label>';

                $overlayed_image_views_jsapps.append(newgroup);
                $('#overlayed_image_views_checkboxes .panel-body').append(checkbox);
                appletInit(params);
            }
          
            //Wait for Applets to be Loaded and Then Retrieve their Base64 String/Screenshot
            //This is necessary because the applets take time to load on the admin side. Hence need
            //to keep trying to get the screenshot of the applets till all applets have loaded successfully
            var applets_loaded = 0;
            var interval_id = setInterval(function() {
                $('#overlayed_image_div .panel-body').empty();
                for(var i = 1; i < numgroups; i++)
                {
                    if(document['overlayed_image_view_applet' + i] !== undefined)
                    {
                        var a = document['overlayed_image_view_applet' + i].getPNGBase64(1.5, true, undefined);
                        var img = '<img src="data:image/png;base64,'+a+'" id="img_'+i+'" style="position:absolute;">';
                        $('#overlayed_image_div .panel-body').append(img);
                    }
                }
                //Once all Applets are Loaded Stop Trying
                if(applets_loaded == 1)
                {
                    clearInterval(interval_id);
                }
                if(document['overlayed_image_view_applet1'] !== undefined || numgroups === 0 )
                {
                    applets_loaded = 1;
                }
            }, 4000);            
        } else {
             $design_toolbox.empty();
        }
        socket.get_class_users(sessionStorage.getItem('admin_class_id'),'get-class-users-response');
    });
});

